import { expectChildToMatch, spawnTestChild } from '../../helpers/index.js';
import { composeWalletCommand } from './helpers/index.js';

test('SUCCEEDS: No subaccount option (account with subaccounts)', async () => {
  const options = '--key account-with-subaccounts --secret secret';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total               │ Total (USD)     │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┴─────────────────┴────────────┤',
      '│                                                                  Total                                                                   │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1,234.56789123 BTC  │ $123,456,789.12 │     12.50% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1,234.56789123 ETH  │ $123,456,789.12 │     12.50% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1,234.56789123 FTT  │ $123,456,789.12 │     12.50% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 370.37036737 USD         │ 37.03703674 USD             │ 3.70370367 USD  │ 3,703.70367370 USD  │ $370,370,367.37 │     37.50% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 246.91357825 USDT        │ 24.69135782 USDT            │ 2.46913578 USDT │ 2,469.13578247 USDT │ $246,913,578.25 │     25.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $987,654,312.99 │            │',
      '├──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┤',
      '│                                                               Main account                                                               │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1,234.56789123 BTC  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1,234.56789123 ETH  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1,234.56789123 FTT  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1,234.56789123 USD  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1,234.56789123 USDT │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $617,283,945.62 │            │',
      '├──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┤',
      '│                                                         Subaccount: a-subaccount                                                         │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1,234.56789123 USD  │ $123,456,789.12 │    100.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $123,456,789.12 │            │',
      '├──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┤',
      '│                                                      Subaccount: empty-subaccount-1                                                      │',
      '├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤',
      '│                                                            No balances found.                                                            │',
      '├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤',
      '│                                                      Subaccount: empty-subaccount-2                                                      │',
      '├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤',
      '│                                                            No balances found.                                                            │',
      '├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤',
      '│                                                         Subaccount: z-subaccount                                                         │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1,234.56789123 USD  │ $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1,234.56789123 USDT │ $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $246,913,578.25 │            │',
      '└──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('SUCCEEDS: No subaccount option (account without subaccounts)', async () => {
  const options = '--key account-without-subaccounts --secret secret';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total               │ Total (USD)     │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┴─────────────────┴────────────┤',
      '│                                                               Main account                                                               │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1,234.56789123 BTC  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1,234.56789123 ETH  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1,234.56789123 FTT  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1,234.56789123 USD  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1,234.56789123 USDT │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $617,283,945.62 │            │',
      '└──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('SUCCEEDS: Subaccount with balances', async () => {
  const options =
    '--key key --secret secret --subaccount subaccount-with-balances';

  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total               │ Total (USD)     │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┴─────────────────┴────────────┤',
      '│                                                   Subaccount: subaccount-with-balances                                                   │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬─────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1,234.56789123 BTC  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1,234.56789123 ETH  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1,234.56789123 FTT  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1,234.56789123 USD  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼─────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1,234.56789123 USDT │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴─────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                                │ $617,283,945.62 │            │',
      '└──────────┴────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('SUCCEEDS: Subaccount without balances', async () => {
  const options =
    '--key key --secret secret --subaccount subaccount-without-balances';

  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬──────────┬───────┬─────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed │ Total │ Total (USD) │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴──────────┴───────┴─────────────┴────────────┤',
      '│                                     Subaccount: subaccount-without-balances                                     │',
      '├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤',
      '│                                               No balances found.                                                │',
      '└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('FAILS: Invalid subaccount', async () => {
  const options = '--key key --secret secret --subaccount invalid-subaccount';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [],
    stderrArray: [/.{24} {2}ERROR {2}No such subaccount/],
    exitCode: 1,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});
