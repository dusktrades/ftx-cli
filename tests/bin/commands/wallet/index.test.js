import { expectChildToMatch, spawnTestChild } from '../../helpers/index.js';
import { composeWalletCommand } from './helpers/index.js';

test('SUCCEEDS: No subaccount option (account with subaccounts)', async () => {
  const options = '--key account-with-subaccounts --secret secret';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬───────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total              │ Total (USD)       │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┴───────────────────┴────────────┤',
      '│                                                                   Total                                                                   │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬───────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1234.56789123 BTC  │   $123,456,789.12 │     11.11% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1234.56789123 ETH  │   $123,456,789.12 │     11.11% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1234.56789123 FTT  │   $123,456,789.12 │     11.11% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USD      │ 370.37036737 USD         │ 37.03703674 USD             │ 3.70370367 USD  │ 3703.70367370 USD  │   $370,370,367.37 │     33.33% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USDT     │ 370.37036737 USDT        │ 37.03703674 USDT            │ 3.70370367 USDT │ 3703.70367370 USDT │   $370,370,367.37 │     33.33% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼───────────────────┼────────────┤',
      '│ Total    │                                                                                               │ $1,111,111,102.11 │            │',
      '├──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────┴────────────┤',
      '│                                                               Main account                                                                │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬───────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1234.56789123 BTC  │   $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1234.56789123 ETH  │   $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1234.56789123 FTT  │   $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1234.56789123 USD  │   $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1234.56789123 USDT │   $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼───────────────────┼────────────┤',
      '│ Total    │                                                                                               │   $617,283,945.62 │            │',
      '├──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────┴────────────┤',
      '│                                                         Subaccount: a-subaccount                                                          │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬───────────────────┬────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1234.56789123 USD  │   $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1234.56789123 USDT │   $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼───────────────────┼────────────┤',
      '│ Total    │                                                                                               │   $246,913,578.25 │            │',
      '├──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────┴────────────┤',
      '│                                                         Subaccount: z-subaccount                                                          │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬───────────────────┬────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1234.56789123 USD  │   $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼───────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1234.56789123 USDT │   $123,456,789.12 │     50.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼───────────────────┼────────────┤',
      '│ Total    │                                                                                               │   $246,913,578.25 │            │',
      '└──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('SUCCEEDS: No subaccount option (account without subaccounts)', async () => {
  const options = '--key account-without-subaccounts --secret secret';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬─────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total              │ Total (USD)     │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┴─────────────────┴────────────┤',
      '│                                                              Main account                                                               │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1234.56789123 BTC  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1234.56789123 ETH  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1234.56789123 FTT  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1234.56789123 USD  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1234.56789123 USDT │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                               │ $617,283,945.62 │            │',
      '└──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('SUCCEEDS: Valid subaccount', async () => {
  const options = '--key key --secret secret --subaccount subaccount';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [
      '┌──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬─────────────────┬────────────┐',
      '│ Currency │ Available with borrowing │ Available without borrowing │ Borrowed        │ Total              │ Total (USD)     │ Allocation │',
      '├──────────┴──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┴─────────────────┴────────────┤',
      '│                                                         Subaccount: subaccount                                                          │',
      '├──────────┬──────────────────────────┬─────────────────────────────┬─────────────────┬────────────────────┬─────────────────┬────────────┤',
      '│ BTC      │ 123.45678912 BTC         │ 12.34567891 BTC             │ 1.23456789 BTC  │ 1234.56789123 BTC  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ ETH      │ 123.45678912 ETH         │ 12.34567891 ETH             │ 1.23456789 ETH  │ 1234.56789123 ETH  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ FTT      │ 123.45678912 FTT         │ 12.34567891 FTT             │ 1.23456789 FTT  │ 1234.56789123 FTT  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ USD      │ 123.45678912 USD         │ 12.34567891 USD             │ 1.23456789 USD  │ 1234.56789123 USD  │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┼─────────────────────────────┼─────────────────┼────────────────────┼─────────────────┼────────────┤',
      '│ USDT     │ 123.45678912 USDT        │ 12.34567891 USDT            │ 1.23456789 USDT │ 1234.56789123 USDT │ $123,456,789.12 │     20.00% │',
      '├──────────┼──────────────────────────┴─────────────────────────────┴─────────────────┴────────────────────┼─────────────────┼────────────┤',
      '│ Total    │                                                                                               │ $617,283,945.62 │            │',
      '└──────────┴───────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────┴────────────┘',
    ],
    stderrArray: [],
    exitCode: 0,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});

test('FAILS: Invalid subaccount', async () => {
  const options = '--key key --secret secret --subaccount invalid-subaccount';
  const command = composeWalletCommand(options);

  const expectedChild = {
    stdoutArray: [],
    stderrArray: [/.{24} {2}ERROR {2}No such subaccount/],
    exitCode: 1,
  };

  const child = spawnTestChild(command);

  await expectChildToMatch(child, expectedChild);
});
